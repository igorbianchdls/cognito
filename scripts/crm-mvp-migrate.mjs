#!/usr/bin/env node

import { Client } from "pg";
import dotenv from "dotenv";
import fs from "node:fs";
import path from "node:path";

function loadEnvFiles() {
  // Do not override already-set env vars.
  try {
    const cwd = process.cwd();
    const candidates = [
      ".env.local",
      ".env",
      ".env.development.local",
      ".env.development",
      ".env.production.local",
      ".env.production",
    ].map((f) => path.join(cwd, f));
    for (const envPath of candidates) {
      if (fs.existsSync(envPath)) dotenv.config({ path: envPath, override: false });
    }
  } catch {
    // ignore
  }
}

async function ensureConstraint(client, { schema, table, name, sql }) {
  const exists = await client.query(
    `
    select 1
    from information_schema.table_constraints
    where constraint_schema = $1
      and table_name = $2
      and constraint_name = $3
    limit 1
  `,
    [schema, table, name]
  );

  if (exists.rowCount > 0) return;
  await client.query(sql);
}

async function main() {
  loadEnvFiles();

  const dbUrl = process.env.SUPABASE_DB_URL;
  if (!dbUrl) {
    console.error("SUPABASE_DB_URL ausente (adicione em .env.local).");
    process.exit(1);
  }

  const client = new Client({
    connectionString: dbUrl,
    ssl: { rejectUnauthorized: false },
  });

  await client.connect();
  try {
    await client.query("BEGIN");

    // 1) Core tables: contas + contatos
    await client.query(`
      CREATE TABLE IF NOT EXISTS crm.contas (
        id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        tenant_id bigint NOT NULL DEFAULT 1,
        nome varchar NOT NULL,
        setor varchar NULL,
        site varchar NULL,
        telefone varchar NULL,
        endereco_cobranca text NULL,
        responsavel_id bigint NULL, -- comercial.vendedores.id
        criado_em timestamp without time zone NULL DEFAULT now(),
        atualizado_em timestamp without time zone NULL DEFAULT now()
      )
    `);

    await client.query(`
      CREATE TABLE IF NOT EXISTS crm.contatos (
        id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        tenant_id bigint NOT NULL DEFAULT 1,
        conta_id bigint NULL,
        nome varchar NOT NULL,
        cargo varchar NULL,
        email varchar NULL,
        telefone varchar NULL,
        responsavel_id bigint NULL, -- comercial.vendedores.id
        criado_em timestamp without time zone NULL DEFAULT now(),
        atualizado_em timestamp without time zone NULL DEFAULT now()
      )
    `);

    await ensureConstraint(client, {
      schema: "crm",
      table: "contatos",
      name: "contatos_conta_fk",
      sql: `ALTER TABLE crm.contatos ADD CONSTRAINT contatos_conta_fk FOREIGN KEY (conta_id) REFERENCES crm.contas(id)`,
    });

    await client.query(`CREATE INDEX IF NOT EXISTS contas_tenant_id_idx ON crm.contas (tenant_id)`);
    await client.query(`CREATE INDEX IF NOT EXISTS contatos_tenant_id_idx ON crm.contatos (tenant_id)`);
    await client.query(`CREATE INDEX IF NOT EXISTS contatos_conta_id_idx ON crm.contatos (conta_id)`);
    await client.query(`CREATE INDEX IF NOT EXISTS contas_responsavel_id_idx ON crm.contas (responsavel_id)`);
    await client.query(`CREATE INDEX IF NOT EXISTS contatos_responsavel_id_idx ON crm.contatos (responsavel_id)`);

    // 2) Add missing columns to existing tables (idempotent)
    await client.query(`ALTER TABLE crm.oportunidades ADD COLUMN IF NOT EXISTS nome varchar NULL`);
    await client.query(`ALTER TABLE crm.oportunidades ADD COLUMN IF NOT EXISTS conta_id bigint NULL`);
    await client.query(`ALTER TABLE crm.oportunidades ADD COLUMN IF NOT EXISTS data_fechamento date NULL`);

    await ensureConstraint(client, {
      schema: "crm",
      table: "oportunidades",
      name: "op_conta_fk",
      sql: `ALTER TABLE crm.oportunidades ADD CONSTRAINT op_conta_fk FOREIGN KEY (conta_id) REFERENCES crm.contas(id)`,
    });
    await client.query(`CREATE INDEX IF NOT EXISTS oportunidades_conta_id_idx ON crm.oportunidades (conta_id)`);

    // Fill missing nomes for existing opportunities and enforce not null.
    await client.query(`
      UPDATE crm.oportunidades
      SET nome = COALESCE(nome, 'Oportunidade #' || id::text)
      WHERE nome IS NULL
    `);
    // Only make NOT NULL if column exists and there are no NULLs.
    const nullsOpp = await client.query(`SELECT COUNT(*)::int AS n FROM crm.oportunidades WHERE nome IS NULL`);
    if ((nullsOpp.rows?.[0]?.n ?? 0) === 0) {
      await client.query(`ALTER TABLE crm.oportunidades ALTER COLUMN nome SET NOT NULL`);
    }

    // Leads: conversion + optional links
    await client.query(`ALTER TABLE crm.leads ADD COLUMN IF NOT EXISTS conta_id bigint NULL`);
    await client.query(`ALTER TABLE crm.leads ADD COLUMN IF NOT EXISTS contato_id bigint NULL`);
    await client.query(`ALTER TABLE crm.leads ADD COLUMN IF NOT EXISTS oportunidade_id bigint NULL`);
    await client.query(`ALTER TABLE crm.leads ADD COLUMN IF NOT EXISTS convertido_em timestamp without time zone NULL`);

    await ensureConstraint(client, {
      schema: "crm",
      table: "leads",
      name: "leads_conta_fk",
      sql: `ALTER TABLE crm.leads ADD CONSTRAINT leads_conta_fk FOREIGN KEY (conta_id) REFERENCES crm.contas(id)`,
    });
    await ensureConstraint(client, {
      schema: "crm",
      table: "leads",
      name: "leads_contato_fk",
      sql: `ALTER TABLE crm.leads ADD CONSTRAINT leads_contato_fk FOREIGN KEY (contato_id) REFERENCES crm.contatos(id)`,
    });
    await ensureConstraint(client, {
      schema: "crm",
      table: "leads",
      name: "leads_oportunidade_fk",
      sql: `ALTER TABLE crm.leads ADD CONSTRAINT leads_oportunidade_fk FOREIGN KEY (oportunidade_id) REFERENCES crm.oportunidades(id)`,
    });

    await client.query(`CREATE INDEX IF NOT EXISTS leads_conta_id_idx ON crm.leads (conta_id)`);
    await client.query(`CREATE INDEX IF NOT EXISTS leads_contato_id_idx ON crm.leads (contato_id)`);
    await client.query(`CREATE INDEX IF NOT EXISTS leads_oportunidade_id_idx ON crm.leads (oportunidade_id)`);

    // Activities: support linking to conta/contato + subject/notes (optional)
    await client.query(`ALTER TABLE crm.atividades ADD COLUMN IF NOT EXISTS conta_id bigint NULL`);
    await client.query(`ALTER TABLE crm.atividades ADD COLUMN IF NOT EXISTS contato_id bigint NULL`);
    await client.query(`ALTER TABLE crm.atividades ADD COLUMN IF NOT EXISTS assunto varchar NULL`);
    await client.query(`ALTER TABLE crm.atividades ADD COLUMN IF NOT EXISTS anotacoes text NULL`);

    await ensureConstraint(client, {
      schema: "crm",
      table: "atividades",
      name: "atividades_conta_fk",
      sql: `ALTER TABLE crm.atividades ADD CONSTRAINT atividades_conta_fk FOREIGN KEY (conta_id) REFERENCES crm.contas(id)`,
    });
    await ensureConstraint(client, {
      schema: "crm",
      table: "atividades",
      name: "atividades_contato_fk",
      sql: `ALTER TABLE crm.atividades ADD CONSTRAINT atividades_contato_fk FOREIGN KEY (contato_id) REFERENCES crm.contatos(id)`,
    });

    await client.query(`CREATE INDEX IF NOT EXISTS atividades_conta_id_idx ON crm.atividades (conta_id)`);
    await client.query(`CREATE INDEX IF NOT EXISTS atividades_contato_id_idx ON crm.atividades (contato_id)`);

    // Interactions: link to conta/contato
    await client.query(`ALTER TABLE crm.interacoes ADD COLUMN IF NOT EXISTS conta_id bigint NULL`);
    await client.query(`ALTER TABLE crm.interacoes ADD COLUMN IF NOT EXISTS contato_id bigint NULL`);

    await ensureConstraint(client, {
      schema: "crm",
      table: "interacoes",
      name: "interacoes_conta_fk",
      sql: `ALTER TABLE crm.interacoes ADD CONSTRAINT interacoes_conta_fk FOREIGN KEY (conta_id) REFERENCES crm.contas(id)`,
    });
    await ensureConstraint(client, {
      schema: "crm",
      table: "interacoes",
      name: "interacoes_contato_fk",
      sql: `ALTER TABLE crm.interacoes ADD CONSTRAINT interacoes_contato_fk FOREIGN KEY (contato_id) REFERENCES crm.contatos(id)`,
    });

    await client.query(`CREATE INDEX IF NOT EXISTS interacoes_conta_id_idx ON crm.interacoes (conta_id)`);
    await client.query(`CREATE INDEX IF NOT EXISTS interacoes_contato_id_idx ON crm.interacoes (contato_id)`);

    await client.query("COMMIT");
    console.log("CRM migration applied successfully.");
  } catch (error) {
    try {
      await client.query("ROLLBACK");
    } catch {
      // ignore
    }
    console.error(error instanceof Error ? error.message : String(error));
    process.exitCode = 1;
  } finally {
    await client.end().catch(() => {});
  }
}

main();

